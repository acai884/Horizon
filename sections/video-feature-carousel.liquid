{% comment %}
  Video Feature Carousel Section
  Displays product features as a dynamic carousel of video cards
  Uses Swiper.js with centered mode and sneak peek overflow effect
{% endcomment %}

<!-- Resource preconnect optimization -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<!-- Load Montserrat font from Google Fonts -->
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" as="style">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap">

<!-- Load Swiper library -->
{% unless settings.swiper_loaded %}
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" as="style">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
{% endunless %}

<style>
  /* CSS Variables */
  .video-feature-section-{{ section.id }} {
    --section-bg-color: {{ section.settings.section_bg_color }};
    --heading-color: {{ section.settings.heading_color }};
    --card-padding: 24px;
    --card-border-radius: 16px;
    --arrow-color: #FF4A00;
    --arrow-bg: rgba(255, 255, 255, 0.9);
    --arrow-size: 50px;
  }

  /* Section Styles */
  .video-feature-section-{{ section.id }} {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
    background-color: var(--section-bg-color);
    font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  /* Main Heading */
  .video-feature-heading {
    text-align: center;
    margin: 0 auto 40px;
    font-size: 36px;
    font-weight: 600;
    color: var(--heading-color);
    max-width: 1200px;
    padding: 0 20px;
  }

  /* Carousel Container */
  .video-feature-carousel-container {
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
    position: relative;
  }

  .video-feature-swiper {
    width: 100%;
    overflow: visible;
    padding: 0 60px;
  }

  .video-feature-swiper .swiper-wrapper {
    display: flex;
    align-items: stretch;
  }

  /* Slide Styles */
  .video-feature-swiper .swiper-slide {
    height: auto;
    display: flex;
  }

  /* Card Container */
  .video-feature-card {
    background-color: {{ section.settings.default_card_bg }};
    border-radius: 26px;
    overflow: hidden;
    height: 100%;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .video-feature-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  /* Video Container */
  .video-feature-video-container {
    position: relative;
    width: 100%;
    aspect-ratio: 16/9;
    overflow: hidden;
    background-color: #e0e0e0;
  }

  .video-feature-video-container video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-top-left-radius: var(--card-border-radius);
    border-top-right-radius: var(--card-border-radius);
  }

  /* Video Placeholder */
  .video-feature-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%);
    color: #999;
    font-size: 16px;
  }

  /* Card Content */
  .video-feature-content {
    padding: var(--card-padding);
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  .video-feature-title {
    font-family: 'Montserrat', sans-serif;
    font-size: 28px;
    font-weight: 600;
    color: #000000;
    margin: 0 0 16px 0;
    line-height: 1.3;
  }

  .video-feature-description {
    font-family: 'Montserrat', sans-serif;
    font-size: 18px;
    font-weight: 400;
    color: #666666;
    margin: 0;
    line-height: 1.6;
  }

  /* Navigation Arrows */
  .video-feature-swiper .swiper-button-next,
  .video-feature-swiper .swiper-button-prev {
    color: var(--arrow-color);
    background-color: var(--arrow-bg);
    width: var(--arrow-size);
    height: var(--arrow-size);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
  }

  .video-feature-swiper .swiper-button-next::after,
  .video-feature-swiper .swiper-button-prev::after {
    font-size: 20px;
    font-weight: bold;
  }

  .video-feature-swiper .swiper-button-next:hover,
  .video-feature-swiper .swiper-button-prev:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(255, 74, 0, 0.3);
  }

  /* Tablet Styles (769px - 1024px) */
  @media screen and (min-width: 769px) and (max-width: 1024px) {
    .video-feature-heading {
      font-size: 32px;
      margin-bottom: 35px;
    }

    .video-feature-title {
      font-size: 24px;
    }

    .video-feature-description {
      font-size: 16px;
    }
  }

  /* Desktop Styles (1025px+) */
  @media screen and (min-width: 1025px) {
    .video-feature-heading {
      font-size: 40px;
      margin-bottom: 50px;
    }
  }

  /* Mobile Styles (â‰¤768px) */
  @media screen and (max-width: 768px) {
    .video-feature-swiper {
      padding: 0 20px;
    }

    .video-feature-heading {
      font-size: 24px;
      margin-bottom: 30px;
      padding: 0 15px;
    }

    .video-feature-title {
      font-size: 20px;
      margin-bottom: 12px;
    }

    .video-feature-description {
      font-size: 14px;
    }

    /* Hide arrows on mobile */
    .video-feature-swiper .swiper-button-next,
    .video-feature-swiper .swiper-button-prev {
      display: none;
    }

    .video-feature-content {
      padding: 20px;
    }
  }

  /* Centered mode optimization */
  .video-feature-swiper .swiper-slide-active .video-feature-card {
    transform: scale(1);
  }
</style>

<section class="video-feature-section-{{ section.id }}">
  {% if section.settings.heading != blank %}
    <h2 class="video-feature-heading">{{ section.settings.heading }}</h2>
  {% endif %}

  <div class="video-feature-carousel-container">
    <div class="swiper video-feature-swiper video-feature-carousel-{{ section.id }}">
      <div class="swiper-wrapper">
        {% for block in section.blocks %}
          <div class="swiper-slide" data-block-id="{{ block.id }}" {{ block.shopify_attributes }}>
            <div 
              class="video-feature-card" 
              style="background-color: {{ block.settings.card_bg_color | default: section.settings.default_card_bg }};"
            >
              <div class="video-feature-video-container">
                {% if block.settings.video != blank %}
                  <video
                    autoplay
                    loop
                    muted
                    playsinline
                    preload="metadata"
                    class="video-feature-video"
                  >
                    {% for source in block.settings.video.sources %}
                      <source src="{{ source.url }}" type="{{ source.mime_type }}">
                    {% endfor %}
                  </video>
                {% else %}
                  <div class="video-feature-placeholder">
                    <span>No video uploaded</span>
                  </div>
                {% endif %}
              </div>

              <div class="video-feature-content">
                {% if block.settings.title != blank %}
                  <h3 
                    class="video-feature-title"
                    style="
                      font-size: {{ block.settings.title_font_size | default: 28 }}px;
                      color: {{ block.settings.title_color | default: '#000000' }};
                    "
                  >
                    {{ block.settings.title }}
                  </h3>
                {% endif %}

                {% if block.settings.description != blank %}
                  <div 
                    class="video-feature-description"
                    style="
                      font-size: {{ block.settings.description_font_size | default: 18 }}px;
                      color: {{ block.settings.description_color | default: '#666666' }};
                    "
                  >
                    {{ block.settings.description }}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Navigation Arrows -->
      <div class="swiper-button-next"></div>
      <div class="swiper-button-prev"></div>
    </div>
  </div>
</section>

<script>
  (function() {
    'use strict';

    const sectionId = '{{ section.id }}';
    const autoplayEnabled = {{ section.settings.enable_autoplay }};
    const autoplaySpeed = {{ section.settings.autoplay_speed | times: 1000 }};

    // Wait for Swiper to be loaded
    function initCarousel() {
      if (typeof Swiper === 'undefined') {
        setTimeout(initCarousel, 100);
        return;
      }

      const container = document.querySelector(`.video-feature-carousel-${sectionId}`);
      if (!container) return;

      // Destroy existing instance if any
      if (container.swiper) {
        container.swiper.destroy(true, true);
      }

      // Get breakpoint-specific configuration
      const isMobile = window.innerWidth <= 768;
      const isTablet = window.innerWidth >= 769 && window.innerWidth <= 1024;
      const isDesktop = window.innerWidth >= 1025;

      // Initialize Swiper
      const swiper = new Swiper(`.video-feature-carousel-${sectionId}`, {
        // Core configuration
        loop: true,
        grabCursor: true,
        watchSlidesProgress: true,

        // Autoplay configuration
        autoplay: autoplayEnabled ? {
          delay: autoplaySpeed,
          disableOnInteraction: false,
          pauseOnMouseEnter: true,
        } : false,

        // Navigation
        navigation: {
          nextEl: `.video-feature-carousel-${sectionId} .swiper-button-next`,
          prevEl: `.video-feature-carousel-${sectionId} .swiper-button-prev`,
        },

        // Responsive breakpoints
        breakpoints: {
          // Mobile (â‰¤768px)
          0: {
            slidesPerView: 1,
            spaceBetween: 20,
            centeredSlides: false,
          },
          // Tablet (769px - 1024px)
          769: {
            slidesPerView: 3,
            spaceBetween: 30,
            centeredSlides: true,
            centeredSlidesBounds: false,
          },
          // Desktop (1025px+)
          1025: {
            slidesPerView: 3,
            spaceBetween: 30,
            centeredSlides: true,
            centeredSlidesBounds: false,
          },
        },

        // Events
        on: {
          init: function() {
            // Play videos on active slide
            playVideosOnSlide(this.slides[this.activeIndex]);
          },
          slideChange: function() {
            // Pause all videos
            pauseAllVideos(this.slides);
            // Play videos on new active slide
            playVideosOnSlide(this.slides[this.activeIndex]);
          },
        },
      });

      // Video management functions
      function playVideosOnSlide(slide) {
        if (!slide) return;
        const videos = slide.querySelectorAll('video');
        videos.forEach(video => {
          video.play().catch(e => console.warn('Video play failed:', e));
        });
      }

      function pauseAllVideos(slides) {
        slides.forEach(slide => {
          const videos = slide.querySelectorAll('video');
          videos.forEach(video => video.pause());
        });
      }

      // Store swiper instance
      container.swiper = swiper;
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCarousel);
    } else {
      initCarousel();
    }

    // Shopify theme editor support
    if (Shopify && Shopify.designMode) {
      document.addEventListener('shopify:section:load', function(event) {
        if (event.detail.sectionId === sectionId) {
          setTimeout(initCarousel, 100);
        }
      });

      document.addEventListener('shopify:section:reorder', function(event) {
        if (event.detail.sectionId === sectionId) {
          setTimeout(initCarousel, 100);
        }
      });

      document.addEventListener('shopify:block:select', function(event) {
        if (event.detail.sectionId === sectionId) {
          const container = document.querySelector(`.video-feature-carousel-${sectionId}`);
          if (container && container.swiper) {
            const blockId = event.detail.blockId;
            const slideIndex = Array.from(container.querySelectorAll('.swiper-slide'))
              .findIndex(slide => slide.dataset.blockId === blockId);
            if (slideIndex !== -1) {
              container.swiper.slideTo(slideIndex);
            }
          }
        }
      });
    }

    // Reinitialize on window resize (debounced)
    let resizeTimer;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(function() {
        const container = document.querySelector(`.video-feature-carousel-${sectionId}`);
        if (container && container.swiper) {
          container.swiper.update();
        }
      }, 250);
    });
  })();
</script>

{% schema %}
{
  "name": "Video Feature Carousel",
  "tag": "section",
  "class": "video-feature-carousel-section",
  "settings": [
    {
      "type": "header",
      "content": "Section Heading"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Main Heading",
      "default": "Introducing the best laser technology",
      "info": "Centered title displayed at the top of the section"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "Carousel Settings"
    },
    {
      "type": "checkbox",
      "id": "enable_autoplay",
      "label": "Enable Autoplay",
      "default": true,
      "info": "Automatically cycle through slides"
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 3,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "Autoplay Speed",
      "default": 5,
      "info": "Time in seconds between slide transitions"
    },
    {
      "type": "header",
      "content": "Card Styling"
    },
    {
      "type": "color",
      "id": "default_card_bg",
      "label": "Default Card Background",
      "default": "#f5f5f5",
      "info": "Default background color for all cards (can be overridden per card)"
    },
    {
      "type": "header",
      "content": "Section Styling"
    },
    {
      "type": "color",
      "id": "section_bg_color",
      "label": "Section Background Color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Section Padding Top",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "Section Padding Bottom",
      "default": 60
    }
  ],
  "blocks": [
    {
      "type": "video_card",
      "name": "Video Card",
      "settings": [
        {
          "type": "header",
          "content": "Video"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video",
          "info": "Upload a Shopify-hosted video. Video will autoplay, loop, and be muted."
        },
        {
          "type": "header",
          "content": "Card Content"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Feature Title",
          "info": "Bold title displayed below the video"
        },
        {
          "type": "range",
          "id": "title_font_size",
          "min": 16,
          "max": 48,
          "step": 2,
          "unit": "px",
          "label": "Title Font Size (Desktop)",
          "default": 28
        },
        {
          "type": "color",
          "id": "title_color",
          "label": "Title Color",
          "default": "#000000"
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description",
          "default": "Describe the feature or benefit showcased in this video.",
          "info": "Description text displayed below the title"
        },
        {
          "type": "range",
          "id": "description_font_size",
          "min": 12,
          "max": 28,
          "step": 2,
          "unit": "px",
          "label": "Description Font Size (Desktop)",
          "default": 18
        },
        {
          "type": "color",
          "id": "description_color",
          "label": "Description Color",
          "default": "#666666"
        },
        {
          "type": "header",
          "content": "Card Styling"
        },
        {
          "type": "color",
          "id": "card_bg_color",
          "label": "Card Background Color",
          "default": "#f5f5f5",
          "info": "Override the default card background color"
        },
        {
          "type": "range",
          "id": "card_border_radius",
          "min": 0,
          "max": 50,
          "step": 2,
          "unit": "px",
          "label": "Card Border Radius",
          "default": 26,
          "info": "Rounded corners for the card"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Video Feature Carousel",
      "blocks": [
        {
          "type": "video_card",
          "settings": {
            "title": "Feature 1",
            "description": "Showcase your first amazing feature with this video card."
          }
        },
        {
          "type": "video_card",
          "settings": {
            "title": "Feature 2",
            "description": "Highlight another great feature of your product."
          }
        },
        {
          "type": "video_card",
          "settings": {
            "title": "Feature 3",
            "description": "Display one more compelling feature with video."
          }
        }
      ]
    }
  ]
}
{% endschema %}
